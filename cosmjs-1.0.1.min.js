// cosmJS
// version 1.0.1
// (c) 2012 Cosm Ltd, a LogMeIn company [pete.correia@cosm.com]
// http://cosm.github.com/cosm-js/
// released under the MIT license
var cosm=function(e){"use strict";var t,n="http://api.cosm.com/v2/",r,i=false,s=function(e){if(typeof e==="function"){e.apply(this,Array.prototype.slice.call(arguments,1))}else if(Object.prototype.toString.apply(e)==="[object Array]"){var t=e.length;while(t--){e[t].apply(this,Array.prototype.slice.call(arguments,1))}}},o=function(e){if(window.console&&window.console.log){window.console.log(e)}},u=function(n){var r=e.extend({type:"get"},n);if(!t){return o("(cosmJS) ::: No API key ::: Set your API key first with cosm.setKey( YOUR_API_KEY ) before using any methods. Check docs for more info.")}if(!r.url){return}r.type=r.type.toUpperCase();if(r.type==="PUT"||r.type==="POST"){if(!r.data||typeof r.data!=="object"){return}else{r.data=JSON.stringify(r.data)}}e.ajax({url:r.url,type:r.type,headers:{"X-ApiKey":t},data:r.data,crossDomain:true,dataType:"json",cache:i}).done(r.done).fail(r.fail).always(r.always)},a={socket:false,socketReady:false,queue:[],resources:[]};a.connect=function(t){if(window.MozWebSocket){window.WebSocket=window.MozWebSocket}if(!a.socket&&window.WebSocket){a.socket=new WebSocket("ws://api.cosm.com:8080/");a.socket.onerror=function(e){if(a.error){a.error(e,this)}a.connect()};a.socket.onclose=function(e){if(a.close){a.close(e,this)}a.connect()};a.socket.onopen=function(e){a.socketReady=true;if(a.open){a.open(e,this)}if(a.queue.length){s(a.queue)}if(t){t(this)}};a.socket.onmessage=function(t){var n=t.data,r=JSON.parse(n);if(r.body){e("body").trigger("cosm."+r.resource,r.body)}}}};a.subscribe=function(n,r){var i='{"headers":{"X-ApiKey":"'+t+'"}, "method":"subscribe", "resource":"'+n+'"}';if(!t){return o("(cosmJS) ::: No API key ::: Set your API key first with cosm.setKey( YOUR_API_KEY ) before using any methods. Check docs for more info.")}if(!a.resources[n]){a.resources.push(n);if(!a.socketReady){a.connect();a.queue.push(function(){a.socket.send(i)})}else{a.socket.send(i)}}if(r&&typeof r==="function"){e(document).on("cosm."+n,r)}};a.unsubscribe=function(e){var n='{"headers":{"X-ApiKey":"'+t+'"}, "method":"unsubscribe", "resource":"'+e+'"}';if(!t){return o("(cosmJS) ::: No API key ::: Set your API key first with cosm.setKey( YOUR_API_KEY ) before using any methods. Check docs for more info.")}if(a.socket){a.socket.send(n)}};e.ajaxSetup({cache:i});r={endpoint:n,setEndpoint:function(e){n=e},setCache:function(t){if(t!==i){i=t;e.ajaxSetup({cache:i})}},setKey:function(e){t=e},request:function(e){u(e)},subscribe:function(e,t){a.subscribe(e,t)},unsubscribe:function(e){a.unsubscribe(e)},live:function(t,r){var i=function(n,i){var s=n.current_value?n:i;if(s.current_value){e(t).each(function(){e(this).html(s.current_value).attr("data-cosm-resource",r)})}};u({url:n+r.replace(/^\//,""),always:i});a.subscribe(r,i)},stop:function(t){a.unsubscribe(e(t).first().attr("data-cosm-resource"))},feed:{get:function(e,t){u({url:n+"feeds/"+e+".json",always:t})},update:function(e,t,r){u({type:"put",url:n+"feeds/"+e+".json",data:t,always:r})},"new":function(e,t){u({type:"post",url:n+"feeds",data:e,always:t})},"delete":function(e,t){u({type:"delete",url:n+"feeds/"+e,always:t})},history:function(e,t,r){u({url:n+"feeds/"+e+".json",data:t,always:r})},list:function(e,t){u({url:n+"feeds",data:e,always:t})},subscribe:function(e,t){if(e){a.subscribe("/feeds/"+e,t)}},unsubscribe:function(e,t){if(e){a.unsubscribe("/feeds/"+e)}}},datastream:{get:function(e,t,r){u({url:n+"feeds/"+e+"/datastreams/"+t+".json",always:r})},update:function(e,t,r,i){u({type:"put",url:n+"feeds/"+e+"/datastreams/"+t+".json",data:r,always:i})},"new":function(e,t,r){u({type:"post",url:n+"feeds/"+e+"/datastreams",data:t,always:r})},"delete":function(e,t,r){u({type:"delete",url:n+"feeds/"+e+"/datastreams/"+t,always:r})},history:function(e,t,r,i){u({url:n+"feeds/"+e+"/datastreams/"+t+".json",data:r,always:i})},list:function(e,t){u({url:n+"feeds/"+e+".json",always:function(e){t.call(this,e.datastreams)}})},subscribe:function(e,t,n){if(e&&t){a.subscribe("/feeds/"+e+"/datastreams/"+t,n)}},unsubscribe:function(e,t,n){if(e&&t){a.unsubscribe("/feeds/"+e+"/datastreams/"+t)}},live:function(e,t,n){if(e&&t&&n){r.live(e,"/feeds/"+t+"/datastreams/"+n)}},stop:function(e){if(e){r.stop(e)}}},datapoint:{get:function(e,t,r,i){u({url:n+"feeds/"+e+"/datastreams/"+t+"/datapoints/"+r,always:i})},update:function(e,t,r,i,s){u({type:"put",url:n+"feeds/"+e+"/datastreams/"+t+"/datapoints/"+r,data:{value:i},always:s})},"new":function(e,t,r,i){u({type:"post",url:n+"feeds/"+e+"/datastreams/"+t+"/datapoints",data:r,always:i})},"delete":function(e,t,r,i){var s={type:"delete",always:i};if(typeof r==="object"){s.url=n+"feeds/"+e+"/datastreams/"+t+"/datapoints";s.data=r}else{s.url=n+"feeds/"+e+"/datastreams/"+t+"/datapoints/"+r}u(s)},history:function(e,t,r,i){u({url:n+"feeds/"+e+"/datastreams/"+t+".json",data:r,always:function(e){i.call(this,e.datapoints)}})}}};return r}(jQuery);(function(e){"use strict";var t=function(e){if(typeof e==="object"){return"/feeds/"+e.feed+(e.datastream?"/datastreams/"+e.datastream:"")}else if(typeof e==="string"&&e!==""){return e}else{return""}},n={live:function(e){cosm.live(this,t(e));return this},get:function(n){var r=e(this);cosm.request({url:cosm.endpoint+t(n)+".json",always:function(t){r.each(function(){e(this).html(t.current_value)})}});return this}};e.fn.cosm=function(t){if(n[t]){return n[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return n.init.apply(this,arguments)}else{e.error("Method "+t+" does not exist on jQuery.tooltip")}}})(jQuery)
